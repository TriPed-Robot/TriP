Tutorials
************

.. toctree::
   :hidden:
   

   
Building a Robot Model
======================

Building a robot is the first step in using the functionality of TriP.
This Tutorial will show how to buil a leg of the `TriPed robot  <https://triped-robot.github.io/docs/robot/>`_  shown below:


.. image:: https://user-images.githubusercontent.com/22688144/124489566-6d70f000-ddb1-11eb-9f57-6a2d9e374fcc.png?raw=true
    :alt: triped


Here each leg was highlighted in a different color.
More information about the triped legs can be found `here <https://triped-robot.github.io/docs/legs/>`_ .

The first step in setting up a robot is identifying the kinematic groups.
This is requires some knowledge about kinematic structures, but as a generale rule, each time multiple moving parts converge in a single location they should be part of a group.
Specifically they are in all likelyhood part of something called a closed kinematic chain.
The name is derived from the fact that the moving parts form closed loops.
A good first step when dividing a robot into groups is first identifying these closed chains.

These closed chains will either be connected directly to each other or using a series of other moving parts.
Such a series is called a open kinematic chain.
Each open chain is also considered a group.

In the case of the TriPed the following chains can be identified:

.. image:: images/triped_hybrid_chain.png
    :alt: triped-hybrid_chain

This in turn means that the leg of the TriPed is made up of two kinematic groups.

Once each group has been identified the group construction worklow goes like this:

.. image:: images/trip_sameple_workflow.png
    :alt: trip_sample_workflow

Building virtual open chains
----------------------------

In the case of the TriPed two virtual open chains have to be set up, one for each group.
According to the kinematic transformations described `here <https://triped-robot.github.io/docs/kinematics/>`_ the virtual open chain of the closed chain can be defined using:

.. literalinclude:: ../../src/trip_robots/triped.py
   :language: python
   :linenos:
   :lines: 159-164

While the virtual open chain of the open chain (wich are identical) can be defined using:

.. literalinclude:: ../../src/trip_robots/triped.py
   :language: python
   :linenos:
   :lines: 168-176


Create Mappings
---------------

For the closed chain a mapping from the actuated swing_joints to the virtual joint have to be provided. These joints can be seen down below:

.. image:: images/triped_mapping.png
    :alt: triped_mapping


The mapping between these joints can be computet by solving a geometric closing equation. As pictured above, the tip :math:`x_i` the output lever connected to the actuated joints  :math:`i`
alwas intersects the sphere at position :math:`c_i` where :math:`i` is either 1 or 2.

Mathematically this can be described using:

.. math::
       \sum_{i=1}^2||(c_i(rx,ry,rz^v)-p_{_i}(rz_i^a))^T(c_i(rx,ry,rz^v)-p_{i}(rz_i^a))-r^2||^2 = 0

Where :math:`rx,ry,rz` are the rotation around the x, y and z axis and the suberscript :math:`v,~a`denotes the virtual and actuated state respectively.

The virtual_to_actuated and actuated_to_virtual mappings can now be defined as the virtual or actuated state that solves the closure equation assuming the other state as a fixed value.
This can be done using casadis opti stack.
The final code can be seen down below:

.. literalinclude:: ../../src/trip_robots/triped.py
   :language: python
   :linenos:
   :lines: 10-157

Note that for the open chains no mappings are necessairy as the virtual and actuated state differs only in their dictionary structure.
This trivial mapping is autogenerated by TriP

Building the groups
-------------------

Using both the mappings and the virtual open chain, the groups can be build:

.. literalinclude:: ../../src/trip_robots/triped.py
   :language: python
   :linenos:
   :lines: 165-166

.. literalinclude:: ../../src/trip_robots/triped.py
   :language: python
   :linenos:
   :lines: 178-179

Where `leg_linear_part` is the name of the open chain. 
Note that the closed chain specifies no parent since it is located directly at the robots base and the open chain specifies no mappings since these are autogenerated.

Combining groups to a robot
---------------------------

The last step is to combine the groups into a robot object:
::

    triped_leg = Robot([closed_chain, leg_linear_part])


